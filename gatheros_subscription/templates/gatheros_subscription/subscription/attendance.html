{% extends "gatheros_event/event/base_panel.html" %}
{% load i18n static %}
{% load subscription_tags %}

{% block extrascript %}
    <script type="text/javascript">
        function configure_input(field_name) {
            var input = document.getElementById('search_input');
            var size;
            switch (field_name) {
                case 'code':
                    size = 10;
                    input.setAttribute('type', 'search');
                    break;
                case 'email':
                    input.setAttribute('type', 'email');
                    size = 40;
                    break;
                default:
                    input.setAttribute('type', 'search');
                    size = 60;
            }

            input.setAttribute('size', size);
            input.focus();
            {% if search_by == 'code' and result %}
                document.getElementById('registration_button').focus();
            {% else %}
                input.focus();
            {% endif %}
        }

        document.addEventListener('DOMContentLoaded', function() {
            configure_input('{{ search_by }}');

            {% if search_by == 'code' and result %}
                window.setTimeout(function() {
                    document.getElementById('registration_button').focus()
                }, 500);
            {% endif %}
        }, false);
    </script>
{% endblock %}

{% block content %}
    <div style="padding:10px">
        <a href="{% url 'event:event-panel' event.pk %}">Voltar</a>
    </div>
    <hr/>
    <h1>{{ event.name }}</h1>
    <div style="margin-bottom:10px;padding: 10px;background-color: #DDDDDD;text-align: center;"></div>

    <table width="100%" border="0" cellspacing="5">
        <tr>
            <td style="vertical-align: top">
                <h2>Credenciamento</h2>
                <br />
                <form method="post" action="">{% csrf_token %}
                    <table width="100%" border="0" cellspacing="10" cellpadding="5">
                        <tr>
                            <th style="text-align: right" width="15%">Procurar por:</th>
                            <td>
                                <input {% if search_by == 'name' %}checked{% endif %} type="radio" name="search_by" id="search_by_name" value="name" onclick="window.location.href=window.location.pathname" />
                                <label for="search_by_name">Nome</label>
                                &nbsp; &nbsp; &nbsp;
                                <input {% if search_by == 'email' %}checked{% endif %} type="radio" name="search_by" id="search_by_email" value="email" onclick="window.location.href=window.location.pathname+'?search_by=email'" />
                                <label for="search_by_email">E-mail</label>
                                &nbsp; &nbsp; &nbsp;
                                <input {% if search_by == 'code' %}checked{% endif %} type="radio" name="search_by" id="search_by_code" value="code" onclick="window.location.href=window.location.pathname+'?search_by=code'" />
                                <label for="search_by_code">Código</label>
                            </td>
                        </tr>
                        <tr>
                            <th style="text-align: right">
                                <label for="search_by_name_input">Informe o nome:</label>
                            </th>
                            <td>
                                <input required type="search" name="value" value="" id="search_input" size="60" />
                                <button type="submit">Buscar</button>
                            </td>
                        </tr>
                    </table>
                </form>

                {% if result_by in 'code,email'|slice:',' and result %}
                    {% if result_by == 'code' %}
                        <h2>Resultado por "Código"</h2>
                    {% endif %}
                    {% if result_by == 'email' %}
                        <h2>Resultado por "E-mail"</h2>
                    {% endif %}
                    <br />

                    <table border="0" width="100%" cellpadding="10" cellspacing="1">
                        {% if result.attended %}
                            <tr>
                                <td colspan="3" style="background-color: darkgreen;color: #FFF;font-weight: bold">
                                    Esta inscrição já foi credenciada em '{{ result.attended_on }}'.
                                </td>
                            </tr>
                        {% endif %}
                        <tr>
                            <td width="1%" style="vertical-align:top;font-weight: bold">
                                {% if result.person.avatar %}
                                    <img src="{{ result.person.avatar.url }}" width="240px" />
                                {% else %}
                                    <!--suppress CheckImageSize -->
                                    <img src="/media/default_avatar.png" width="240px" />
                                {% endif %}
                            </td>
                            <td style="padding: 0">
                                <h5 style="font-size: 32px;margin: 12px 0">{{ result.person.name }}</h5>
                                <table border="0" width="100%" cellpadding="10" cellspacing="0">
                                    {% if result.person.user_id %}
                                    <tr>
                                        <th width="26%" style="text-align: right;vertical-align: top">
                                            Perfil
                                        </th>
                                        <td style="vertical-align: top">
                                            &#10004;
                                        </td>
                                    </tr>
                                    {% endif %}
                                    <tr>
                                        <th width="26%" style="text-align: right;vertical-align: top">
                                            Lote
                                        </th>
                                        <td style="vertical-align: top">
                                            {{ result.lot.name }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th width="26%" style="text-align: right;vertical-align: top">
                                            E-mail
                                        </th>
                                        <td style="vertical-align: top">
                                            {{ result.person.email }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th width="26%" style="text-align: right;vertical-align: top">
                                            Código de Inscrição
                                        </th>
                                        <td style="vertical-align: top">
                                            {{ result.code }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th width="20%" style="text-align: right;vertical-align: top">
                                            Cadastrado em
                                        </th>
                                        <td style="vertical-align: top">
                                            {{ result.created }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th width="20%" style="text-align: right;vertical-align: top">
                                            Cadastrado por
                                        </th>
                                        <td style="vertical-align: top">
                                            {{ result.created_by }}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td width="18%" style="text-align: center">
                                <form method="post" action="{% url 'subscription:subscription-attendance' event.pk result.pk %}">{% csrf_token %}
                                    <input type="hidden" name="search_by" value="code" />
                                    <input type="hidden" name="action" value="{% if result.attended %}unregister{% else %}register{% endif %}" />
                                    <button id="registration_button" type="submit">{% if result.attended %}Cancelar credenciamento{% else %}Credenciar{% endif %}</button>
                                </form>
                            </td>
                        </tr>
                    </table>
                {% endif %}

                {% if result_by == 'name' and result %}
                    <h2>Resultado por "Nome"</h2>
                    <br />

                    <table width="100%" style="background: #DDD">
                        <tr>
                            <th width="4%" style="border:1px solid #fff;padding:10px"># ID</th>
                            <th style="text-align: left;border:1px solid #fff;padding:10px">
                                Nome do Participante
                            </th>
                            <th width="8%" style="text-align: left;border:1px solid #fff;padding:10px">
                                Lote
                            </th>
                            <th width="10%" style="text-align: left;border:1px solid #fff;padding:10px">
                                Cód. Inscrição
                            </th>
                            <th width="16%" style="text-align: left;border:1px solid #fff;padding:10px">
                                Data Inscrição
                            </th>
                            <th width="2%" style="border:1px solid #fff;padding:10px">Perfil</th>
                            <th width="15%" style="border:1px solid #fff;padding:10px">Credenciado em</th>
                        </tr>
                        {% for item in result %}
                            <tr>
                                <td style="text-align:center;padding:10px;margin-bottom: 3px;{% if item.attended %}background: darkgreen;color: #fff; font-weight: bold;{% else %}background: #FFF{% endif %}">
                                    {{ forloop.counter }}
                                </td>
                                <td style="padding:10px;margin-bottom: 3px;{% if item.attended %}background: darkgreen;color: #fff; font-weight: bold;{% else %}background: #FFF{% endif %}">
                                    {{ item.person.name }}
                                </td>
                                <td style="text-align:center;padding:10px;margin-bottom: 3px;{% if item.attended %}background: darkgreen;color: #fff; font-weight: bold;{% else %}background: #FFF{% endif %}">
                                    {{ item.lot.name }}
                                </td>
                                <td style="text-align:center;padding:10px;margin-bottom: 3px;{% if item.attended %}background: darkgreen;color: #fff; font-weight: bold;{% else %}background: #FFF{% endif %}">
                                    {{ item.code }}
                                </td>
                                <td style="padding:10px;margin-bottom: 3px;{% if item.attended %}background: darkgreen;color: #fff; font-weight: bold;{% else %}background: #FFF{% endif %}">
                                    {{ item.created }}
                                </td>
                                <td style="text-align:center;padding:10px;margin-bottom: 3px;{% if item.attended %}background: darkgreen;color: #fff; font-weight: bold;{% else %}background: #FFF{% endif %}">
                                    {% if item.person.user_id %}
                                        &#10004;
                                    {% endif %}
                                </td>
                                <td style="text-align:center;padding:10px;margin-bottom: 3px;{% if item.attended %}background: darkgreen;color: #fff; font-weight: bold;{% else %}background: #FFF{% endif %}">
                                    <form method="post" action="{% url 'subscription:subscription-attendance' event.pk item.pk %}">{% csrf_token %}
                                        <input type="hidden" name="search_by" value="name" />
                                        <input type="hidden" name="action" value="{% if item.attended %}unregister{% else %}register{% endif %}" />
                                        {% if item.attended %}
                                            <div style="font-size: 14px">{{ item.attended_on }}</div>
                                            <hr >
                                            <button id="registration_button" type="submit">Cancelar credenciamento</button>
                                        {% else %}
                                            <div style="font-size: 14px">Não credenciado</div>
                                            <hr >
                                            <button id="registration_button" type="submit">Credenciar</button>
                                        {% endif %}
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                {% endif %}
            </td>
            <td width="25%" style="vertical-align: top">
                <div style="background-color: whitesmoke;border:1px solid #DDD">
                    <div style="background-color: #666666;color:#fff;padding:10px;text-transform: uppercase;">
                        Histórico:
                    </div>
                    {% for attendance in attendances %}
                        <div style="background: #FFF;padding: 5px;border-bottom: 1px solid #DDD">
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td width="1%">
                                        {% if attendance.person.avatar %}
                                            <img src="{{ attendance.person.avatar.url }}" width="80px" />
                                        {% else %}
                                            <!--suppress CheckImageSize -->
                                            <img src="/media/default_avatar.png" width="80px" />
                                        {% endif %}
                                    </td>
                                    <td style="padding: 5px">
                                        <div style="font-weight: bold;text-transform: uppercase">{{ attendance.person.name }}</div>
                                        <form method="post" action="">{% csrf_token %}
                                            <input type="hidden" name="search_by" value="code" />
                                            <input type="hidden" name="value" value="{{ attendance.code }}" />
                                            <button id="registration_button" type="submit">{{ attendance.code }}</button>
                                        </form>
                                        <div><strong>Data:</strong> {{ attendance.attended_on }}</div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    {% endfor %}
                </div>
            </td>
        </tr>
    </table>



{% endblock %}
