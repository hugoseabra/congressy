{% extends "base/base.html" %}

{% load i18n static  subscription_tags queryset_filter %}

{% block title %} Inscrições | Congressy{% endblock %}

{% block page_title %}Inscrições{% endblock %}

{% block page_sub_title %}
    {{ event.name }}
{% endblock %}

{% block styles %}
    <link rel="stylesheet"
          href="{% static 'assets/plugins/dataTables/css/responsive.bootstrap.min.css' %}">
    <link rel="stylesheet"
          href="{% static 'assets/plugins/dataTables/css/datatables.min.css' %}">
    <link rel="stylesheet"
          href="{% static 'assets/plugins/icheck/css/all.css' %}">
    <link rel="stylesheet"
          href="{% static 'assets/plugins/dataTables/css/responsive.dataTables.min.css' %}">


{% endblock %}

{% block scripts %}
    <script src="{% static 'assets/plugins/dataTables/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'assets/plugins/dataTables/js/dataTables.responsive.min.js' %}"></script>

    <script src="{% static 'assets/plugins/dataTables/js/dataTables.bootstrap.min.js' %}"></script>

    <script src="{% static 'assets/plugins/dataTables/js/responsive.bootstrap.min.js' %}"></script>

    <script src="{% static 'assets/plugins/icheck/js/icheck.min.js' %}"></script>


    <script>
        var customCheckbox = function () {
            $('input.icheck').iCheck({
                checkboxClass: 'icheckbox_flat-green',
                radioClass: 'iradio_flat-blue'
            });
        };


        var get_status_el = function (data, row) {


            var status;

            switch (row.status) {
                case 'confirmed':
                    status = $('#confirmed').clone();
                    break;
                case 'awaiting':
                    status = $('#awaiting').clone();
                    break;
                case 'canceled':
                    status = $('#canceled').clone();
                    break;
                default:
                    console.error("Status desconhecido de inscrição: " + row.status);
                    return;
            }


            status.remove('id');
            status.show();

            return status.prop('outerHTML');


        };

        var get_name_as_link_el = function (data, row) {

            var tag = document.createElement("a");

            tag = $(tag);
            tag.append(data).attr("href", row['link']);


            return tag.prop('outerHTML');

        };

        var get_date_el = function (row) {
            var tag = document.createElement("div");
            tag = $(tag);
            tag.css("margin-left", '18px');

            var span = $(document.createElement('small'));
            span.addClass('text-muted');

            span.append(new Date(row['created']).toLocaleString());

            tag.append(span);
            return tag.prop('outerHTML');

        };

        var get_badge_el = function (row) {

            var tag = document.createElement("div");
            tag = $(tag);
            tag.css("margin-left", '18px');

            var span = $(document.createElement('span'));
            span.addClass('badge badge-info');

            if (row['origin'] === 'manage') {
                span.append('Interno');
                tag.append(span);
                return tag.prop('outerHTML');

            } else if (row['origin'] === 'csv_import') {
                span.append('CSV');
                tag.append(span);
                return tag.prop('outerHTML');
            }

            return ''
        };

        var get_test_badge_el = function (row) {

            var tag = document.createElement("div");
            tag = $(tag);
            tag.css("margin-left", '18px');

            var span = $(document.createElement('span'));
            span.addClass('badge badge-warning');

            if (row['test_subscription']) {
                span.append('Inscrição de teste');
                tag.append(span);
                return tag.prop('outerHTML');

            }

            return ''
        };

        var get_dropdown_btn = function (row) {

            var main = $('#drop_down_btn').clone();
            main.remove("id");


            main.find("#link").attr("href", row['link']).remove("id");
            var edit_link = main.find("#edit_link");
            edit_link.attr("href", row['edit_link']).remove("id");


            if (row['status'] === 'confirmed') {
                var voucher_link = main.find("#voucher_link");
                voucher_link.attr("href", row['voucher_link']).show().remove("id");
            }

            main.show();
            return main.prop('outerHTML');
        };

        var get_hidden_person = function (row) {

            var tag = document.createElement("div");

            tag = $(tag);
            tag.hide();

            var f = [
                'person_cpf',
                'person_city',
                'person_uf',
                'person_phone',
                'person_city_international',
                'person_international_doc',
            ];


            var i;

            for (i = 0; i < f.length; i++) {

                var p = document.createElement("p");
                p = $(p);
                p.append(row[f[i]]);

                tag.append(p)
            }


            return tag.prop('outerHTML');


        };

        $(document).ready(function () {
            customCheckbox();

            var url = '{% url 'api:subscription:subscription-list-api' event.pk %}';

            $('#subscription_table').DataTable({
                "processing": true,
                "serverSide": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                "pageLength": 10,
                "ajax": function (data, callback, settings) {
                    $.get(url, {
                        limit: data.length,
                        offset: data.start,
                    }, function (res) {
                        callback({
                            recordsTotal: res.recordsTotal,
                            recordsFiltered: res.recordsFiltered,
                            data: res.data
                        });
                    });
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {

                    if (aData['category_name']) {
                        $("td:eq(2)", nRow).attr("data-toggle", "tooltip").attr("title", aData['category_name']);
                    }

                },
                // constract columns
                columns: [
                    {
                        data: 'person_name', "render": function (data, type, row, meta) {
                            var statusBall = get_status_el(data, row);
                            var nameWithLink = get_name_as_link_el(data, row);
                            var dateCreated = get_date_el(row);
                            var testBage = get_test_badge_el(row);
                            var badge = get_badge_el(row);

                            return statusBall + '&nbsp;' + nameWithLink + testBage + badge + dateCreated;
                        }
                    },
                    {
                        data: 'code', "render": function (data, type, row, meta) {


                            var hidden = get_hidden_person(row);

                            return data + hidden
                        }
                    },
                    {data: 'lot_name'},
                    {data: 'event_count'},
                    {
                        data: 'link', "render": function (data, type, row, meta) {
                            return get_dropdown_btn(row);

                        }
                    }
                ],
                "language": {
                    sEmptyTable: "Nenhum registro encontrado",
                    sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                    sInfoEmpty: "Mostrando 0 até 0 de 0 registros",
                    sInfoFiltered: "(Filtrados de _MAX_ registros)",
                    sInfoPostFix: "",
                    sInfoThousands: ".",
                    sLengthMenu: "_MENU_ resultados por página",
                    sLoadingRecords: "Carregando...",
                    sProcessing: "Processando...",
                    sZeroRecords: "Nenhum registro encontrado",
                    sSearch: "Pesquisar",
                    oPaginate: {
                        sNext: "Próximo",
                        sPrevious: "Anterior",
                        sFirst: "Primeiro",
                        sLast: "Último"
                    },
                    oAria: {
                        sSortAscending: ": Ordenar colunas de forma ascendente",
                        sSortDescending: ": Ordenar colunas de forma descendente"
                    }
                },
                "columnDefs": [
                    // Disable sort in first, last column
                    {
                        "searchable": false,
                        "orderable": false,
                        "targets": [-1]
                    },
                    {
                        "targets": 1,
                        "orderable": false
                    },
                    {
                        "targets": 3,
                        "orderable": true,
                        "type": 'date-euro'
                    }
                ],
                // Default order
                "order": [[0, 'asc']],
                responsive: true,
            });


        });
    </script>
{% endblock %}

{% block content %}


    <i id="confirmed" class="fa fa-circle" data-toggle="tooltip" data-placement="right"
       style="color:#5cb85c; display: none;"
       data-original-title="Status: confirmado" aria-hidden="true"></i>

    <i id="awaiting" class="fa fa-circle"
       data-toggle="tooltip"
       data-placement="right"
       data-original-title="Status: pendente"
       aria-hidden="true"
       style="color: #f0ad4e;display: none;"></i>
    <i id="canceled" class="fa fa-circle"
       data-toggle="tooltip"
       data-placement="right"
       data-original-title="Status: cancelado"
       aria-hidden="true"
       style="color: #d9534f;display: none;"></i>


    <div id="drop_down_btn" class="btn-group" style="display:none;">
        <button
                type="button"
                class="btn btn-primary btn-trans btn-sm dropdown-toggle"
                data-toggle="dropdown"
                aria-expanded="false">
            <span class="fas fa-cog"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right"
            role="menu">
            <li>
                <a id="link">
                    <i class="fa fa-eye"></i>
                    Visualizar
                </a>
            </li>
            {% if event.allow_internal_subscription %}
                <li>
                    <a id="edit_link">
                        <i class="fas fa-pencil-alt"></i>
                        Editar
                    </a>
                </li>
            {% endif %}

            <li>
                <a id="voucher_link" style="display: none">
                    <i class="fas fa-file-pdf"></i>
                    Voucher
                </a>
            </li>

        </ul>
    </div>



    <div class="row">
        <div class="col-md-12">
            <div class="buttonbar">
                <div class="float-left">
                    <button type="button"
                            class="btn btn-primary {% if not object_list %}disabled{% endif %}"
                            {% if not object_list %}disabled
                            title="Nenhuma inscrição para exportar."{% endif %}
                            onclick="$('#export-form').submit();">
                        <i class="fa fa-download"></i>
                        Exportar
                    </button>
                    <div style="display:none">
                        <form action="{% url 'subscription:subscriptions-export' event.pk %}"
                              method="post" id="export-form">
                            {% csrf_token %}
                        </form>
                    </div>
                </div>

                <div class="float-right">
                    {% if event.feature_configuration.feature_import_via_csv %}
                        <a href="{% url 'importer:csv-list' event.pk %}"
                           class="btn btn-primary">
                            <i class="fas fa-file-excel"></i>
                            Importar via CSV
                        </a>
                    {% endif %}
                    {% if event.feature_configuration.feature_internal_subscription %}
                        <a role="button" class="btn btn-success"
                           href="{% url 'subscription:subscription-add' event.pk %}">
                            <i class="fa fa-plus"></i>
                            Nova inscrição
                        </a>
                    {% endif %}
                </div>

                <div class="clearfix"></div>
            </div>
        </div>
    </div>

    <div class="row tooltip-wrapper">

        <div class="col-md-12">

            <div class="panel panel-primary">

                <div class="panel-body">


                    <div class="col-md-12 table-responsive">

                        <table id="subscription_table"
                               class="table table-striped table-bordered"
                               cellspacing="0">

                            <thead>

                            <tr>

                                <th>Nome do Participante</th>

                                <th width="10%">Código</th>

                                <th width="18%">Lote</th>

                                <th width="10%" class="text-center"># Insc.</th>

                                <th class="text-center" width="5%"></th>

                            </tr>

                            </thead>
                        </table>
                    </div>


                </div>

            </div>

        </div>

    </div>

{% endblock %}