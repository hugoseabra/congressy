{% extends "base/base.html" %}
{% load i18n l10n static queryset_filter %}


{% block title %}
    Inscrição | Congressy
{% endblock %}

{% block page_title %}
    Inscrição
{% endblock %}

{% block page_sub_title %}
    <div>{{ event.name }}</div>
    {% if object %}
        <div class="text-muted" style="margin-top: 12px;">
            {{ object.name }}
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <!--ABSTRACTS DEPENDENCIES-->
    <script src="{% static "assets/js/messenger.js" %}"></script>
    <script src="{% static "assets/js/vendor/moment.js" %}"></script>
    <script src="{% static "assets/js/price-format.min.js" %}"></script>

    <!--ABSTRACTS-->
    {% if DEBUG is True and STAGING_MODE is False %}
    <script src="{% static "assets/js/abstracts/01-dom.js" %}"></script>
    <script src="{% static "assets/js/abstracts/01-error.js" %}"></script>
    <script src="{% static "assets/js/abstracts/01-messenger.js" %}"></script>
    <script src="{% static "assets/js/abstracts/01-uri.js" %}"></script>
    <script src="{% static "assets/js/abstracts/02-alerter.js" %}"></script>
    <script src="{% static "assets/js/abstracts/02-form-field-mapper.js" %}"></script>
    <script src="{% static "assets/js/abstracts/02-http.js" %}"></script>
    <script src="{% static "assets/js/abstracts/03-form.js" %}"></script>
    <script src="{% static "assets/js/abstracts/03-model.js" %}"></script>
    <script src="{% static "assets/js/abstracts/04-collection.js" %}"></script>
    <script src="{% static "assets/js/abstracts/04-model-form.js" %}"></script>
    <script src="{% static "assets/js/abstracts/05-element-list.js" %}"></script>
    <script src="{% static "assets/js/abstracts/05-modal.js" %}"></script>
        {% if event.feature_configuration.feature_manual_payments %}
            <!--INSTALLMENT - LIB-->
            <script src="{% static "assets/js/installment/contract/domain.js" %}"></script>
            <script src="{% static "assets/js/installment/contract/form.js" %}"></script>
            <script src="{% static "assets/js/installment/contract/component.js" %}"></script>
            <script src="{% static "assets/js/installment/part/domain.js" %}"></script>
            <script src="{% static "assets/js/installment/part/service.js" %}"></script>
            <script src="{% static "assets/js/installment/part/component.js" %}"></script>
            <!--INSTALLMENT - USAGE-->
            <script src="{% static "assets/js/installment/usage.js" %}"></script>
            <script>
                $(document).ready(function () {
                    getContracts('{{ object.pk }}');
                });
            </script>
        {% endif %}
    {% else %}
        <script src="{% static "assets/js/abstracts/cgsy-abstracts.js" %}?v=1"></script>
        {% if event.feature_configuration.feature_manual_payments %}
        <script src="{% static "assets/js/installment/cgsy-installment.js" %}?v=3"></script>
        <script>
            $(document).ready(function () {
                getContracts('{{ object.pk }}');
            });
        </script>
        {% endif %}
    {% endif %}

    <script>
        $(document).ready(function () {
            $('#test-sub').on('change', function () {
                var switchState = $('#test-sub').is(":checked");
                var messageState = switchState ? "True" : "False";

                var sender = new cgsy.AjaxSender("{% url 'subscription:subscription-switch-test' event.pk object.pk %}");

                sender.setSuccessCallback(function () {
                    var switchState = $('#test-sub').is(":checked");
                    var messengerMessage = switchState ?
                        "A inscrição agora é uma inscrição de teste" :
                        "A inscrição não é mais uma inscrição de teste";
                    window.cgsy.messenger.triggerSuccess(messengerMessage);
                });
                sender.send('POST', {'state': messageState});
            });
        });

        function show_block(el_to_show, el_to_hide) {
            el_to_show = $(el_to_show);
            el_to_hide = $(el_to_hide);

            el_to_show.show();
            el_to_hide.hide();
        }


        function delete_payment(transaction_id, amount) {
            var message = "Tem certeza que deseja deletar o lançamento de R$ " + amount + " ?";

            document.getElementById('delete-message').innerHTML = message;
            $('#manual-delete-payment-form-modal').modal();
            $('#transaction_id').val(transaction_id);
        }

        function open_checkout() {
            var payment_form_el = $('#checkout_form');
            var checkout = new window.cgsy.pagarme.Checkout(
                '{{ encryption_key }}',
                'boleto',
                payment_form_el
            );
            checkout.add_item(
                'subscription',
                '{{ object.pk }}',
                'Inscrição: {{ event.name }}',
                1,
                parseFloat('{{ object.lot.get_calculated_price|unlocalize }}')
            );
            {% if products %}
                // Adiciona billing de opcionais de produtos/serviços
                {% for product in products %}
                    {% if product.optional_price %}
                        window.cgsy.payment.add_item(
                            'optional-product',
                            '{{ object.pk }}',
                            'Produto/Serviço: {{ event.name }}',
                            1,
                            parseFloat('{{ product.optional_price|unlocalize }}')
                        );
                    {% endif %}
                {% endfor %}
            {% endif %}
            {% if services %}
                // Adiciona billing de opcionais de produtos/serviços
                {% for service in services %}
                    {% if service.optional_price %}
                        window.cgsy.payment.add_item(
                            'optional-product',
                            '{{ object.pk }}',
                            'Produto/Serviço: {{ event.name }}',
                            1,
                            parseFloat('{{ service.optional_price|unlocalize }}')
                        );
                    {% endif %}
                {% endfor %}
            {% endif %}

            checkout.setSuccessCallback(function () {
                var form = new window.cgsy.pagarme.CheckoutForm($('#checkout_form_block'));
                form.setNextUrl("{% url 'subscription:subscription-view' event.pk object.pk %}");
                form.send("{% url 'public:payment-checkout' %}");
            });

            checkout.run();
        }

        $(document).ready(function () {
            Messenger.options = {
                extraClasses: 'messenger-fixed messenger-on-bottom ' +
                    'messenger-on-right',
                theme: 'flat'
            };

            {% if modal == 'manual-payment' %}
                window.setTimeout(function () {
                    $('#manual-payment-form-modal').modal();
                }, 300);
            {% endif %}
            {% if show_details %}
                window.setTimeout(function () {
                    window.location.hash = 'report_detail_hidden';
                }, 500);
            {% endif %}

            {% if messenger %}
                {% for msg in messenger %}
                    Messenger().post({
                        message: '{{ msg.message }}',
                        type: '{{ msg.type }}'
                    });
                {% endfor %}
            {% endif %}

            {% if last_transaction and last_transaction.type == last_transaction.BOLETO and not last_transaction.boleto_url %}
                window.setTimeout(function () {
                    window.location.href = window.location.href;
                }, 7500);
            {% endif %}


            {% if event.feature_configuration.feature_manual_payments is True %}
                $('#new-contract-btn').show();
            {% else %}
                console.log('new_contract not enabled');
            {% endif %}


        });
    </script>
{% endblock %}

{% block styles %}
    <style>
        .transaction-list span {
            font-size: 12px;
        }

        .transaction-list small {
            font-size: 10px;
        }

        .transaction-list hr {
            margin: 5px 0;

        }

        .transaction-list ul {
            padding-left: 20px;
        }

        .cancelled,
        .cancelled span,
        .cancelled small {
            text-decoration: line-through;
            color: #CCC;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="main-profile-content">
        {% if financial %}
            {% include 'subscription/includes/profile-financial.html' %}
        {% else %}
            {% include 'subscription/includes/profile-subscriber.html' %}
        {% endif %}

        {% if survey_answers|length > 0 %}
            <div class="row">
                <div class="col-xl-11 col-lg-11 col-md-12">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel" id="survey-block-hidden">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Respostas
                                        <a href="#"
                                           onclick="show_block('#survey-block-visible', '#survey-block-hidden');return false;"
                                           class="btn btn-link"
                                           style="padding:0;margin:0;font-size:10px;text-transform: lowercase">(mostrar)</a>
                                    </h3>
                                </div>
                            </div>
                            <div class="panel panel-primary" style="display:none"
                                 id="survey-block-visible">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
                                        Respostas <a href="#"
                                                     onclick="show_block('#survey-block-hidden', '#survey-block-visible');return false;"
                                                     class="btn btn-link"
                                                     style="padding:0;margin:0;font-size:10px;text-transform: lowercase">(ocultar)</a>
                                    </h3>
                                </div>
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            {% for item in survey_answers %}
                                                <div class="form-group">
                                                    <label>{{ item.question|title }}</label>
                                                    <div>
                                                        {{ item.human_display }}
                                                        {% if item.is_file %}
                                                            &ensp;&ensp;
                                                            <a href="/media/{{ item.value }}" class="btn btn-sm btn-primary" target="_blank">
                                                                <i class="fas fa-eye"></i> Abrir arquivo
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endfor %}

                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

    </div>

    <div id="checkout_form_block" style="display:none">
        <form id="checkout_form" action="{% url 'public:payment-checkout' %}"
              method="POST">
            {% csrf_token %}
            {{ form.as_p }}
        </form>
    </div>
    <form action="" method="post" id="payment-notify-boleto"
          style="display:none"
          onsubmit="this.next_url.value=window.location.pathname">
        {% csrf_token %}
        <input type="hidden" name="action" value="notify_boleto"/>
        <input type="hidden" name="next_url" value=""/>
    </form>

    {% include 'subscription/includes/form-installment-contract.html' %}
{% endblock %}

{% block modals %}

    {% include 'subscription/includes/modal-manual-payment-form.html' with form=manual_payment_form %}

    {% include 'subscription/includes/modal-delete-manual-payment-form.html' with form=manual_payment_form %}

    {% include 'subscription/includes/modal-part-transaction.html' with manual_form=manual_form%}

    {% include 'abstracts/modal.html' %}

    {% if event.feature_configuration.feature_manual_payments is True %}

    {% endif %}


{% endblock %}
