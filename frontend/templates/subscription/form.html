{% extends "base/base.html" %}
{% load static i18n %}
{% load static %}
{% load base_tags %}
{% load widget_tweaks %}
{% load event_tags %}
{% load form_config_tags %}

{{% block title %}
    {% if object %}Editar{% else %}Nova{% endif %} Inscrição | Congressy
{% endblock %}

{% block page_title %}
    {% if object %}Editar{% else %}Nova{% endif %} Inscrição
{% endblock %}

{% block page_sub_title %}
    {{ event.name }}
{% endblock %}

{% block scripts %}
<script src="{% static "hotsite/js/subscription.js" %}"></script>
<script type="application/javascript">

    $(document).ready(function () {
        $('#id_person-phone').mask("(99) 99999-9999");
        $('#id_person-zip_code').mask("99999-999");

        hotsiteShowHideCepLoader();

        var uf_el = $('#id_person-state');
        var city_el = $('#id_person-city_name');
        window.setTimeout(function () {
            {% if object.city %}
                uf_el.val('{{ object.city.uf }}');
                fetch_cities(uf_el, $('#id_person-city_name'), $('#id_person-city'), '{{ object.city.pk }}');
            {% else %}
                uf_el.val('');
                city_el.val('');
                city_el.prop('disabled', true);
            {% endif %}
        }, 300);

        $('#id_state').change(function () {
            city_el.html($('<option>').text('Carregando...'));
            var that = $(this);
            window.setTimeout(function () {
                fetch_cities($(that), $('#id_city_name'));
            }, 500);
        });

        $('#id_city_name').change(function () {
            $('#id_city').val($(this).val());
        });

        $('#id_zip_code').on('keyup', function () {
            searchByCep();
        });
    });
</script>

{% endblock %}

{% block content %}
    <form action="" method="post" class="" name="subscription_form">
        {% csrf_token %}

        {% if form.non_field_errors %}
            {% render_errors form.non_field_errors %}
        {% endif %}

        {% for hidden_field in form.hidden_fields %}
            {% if hidden_field.errors %}
                {% render_errors hidden_field.errors %}
            {% endif %}
            {{ hidden_field }}
        {% endfor %}

        <div class="row">
            <div class="col-md-12">
                <div class="buttonbar">
                    <div class="float-right">
                        <a href="{% url 'subscription:subscription-list' event.pk %}"
                           class="btn btn-danger">
                            <i class="fas fa-times-circle"></i>
                            Cancelar
                        </a>

                        <button type="submit" class="btn btn-success">
                            <i class="fa fa-save"></i>
                            Salvar
                        </button>
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <div class="panel-title">
                            Dados Principais
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="id_person-city_name">
                                Lote:
                                <small style="color:#C9302C">*</small>
                            </label>
                            <div>
                                <select name="subscription-lot" placeholder="Digite o nome do lote..." class="form-control" id="id_subscription-lot" required="required" {% if not allow_edit_lot %}disabled=""{% endif %} onchange="window.location.href=window.location.pathname+'?lot='+$(this).val()">
                                    {% if not selected_lot %}
                                    <option value=""></option>
                                    {% endif %}
                                    {% for lot in lots %}
                                    <option value="{{ lot.pk }}" {% if selected_lot and selected_lot == lot.pk %}selected="selected"{% endif %}>{{ lot.display_publicly }} - até: {{ lot.date_end|date:'d/m/Y H\hi' }} {% if lot.private  %}<small>(privado)</small>{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% if selected_lot %}
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <div class="panel-title">
                            Dados Principais
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-12">
                                {% render_generic_field form.country %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-9">
                                {% render_generic_field form.name autofocus=True %}

                            </div>
                            <div class="col-md-3">
                                {% render_generic_field form.gender required=True %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-9">
                                {% if config %}
                                    {% render_generic_field form.email config.email False %}
                                {% else %}
                                    {% render_generic_field form.email %}
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                {% if config and config.cpf != config.CPF_HIDE %}
                                    {% if config.cpf == config.CPF_REQUIRED %}
                                        {% render_generic_field form.cpf required=True %}
                                    {% else %}
                                        {% render_generic_field form.cpf %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            {% if config and config.birth_date != config.BIRTH_DATE_HIDE %}
                                <div class="col-md-6">
                                    {% if config.birth_date == config.BIRTH_DATE_REQUIRED %}
                                        {% render_generic_field form.birth_date required=True %}
                                    {% else %}
                                        {% render_generic_field form.birth_date %}
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div class="col-md-6">
                                {% if config %}
                                    {% render_generic_field form.phone config.phone False %}
                                {% else %}
                                    {% render_generic_field form.phone %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                {% if config and config.address == config.ADDRESS_HIDE %}
                                    <div class="row">
                                        <div class="col-md-3 address-row">
                                            {% render_generic_field form.state required=config.city %}
                                        </div>
                                        <div class="col-md-9 address-row">
                                            {% render_generic_field form.city_name required=config.city %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            {% if config and config.institution_show is True %}
                                <div class="col-md-4">
                                    {% render_generic_field form.institution required=config.institution_required %}
                                </div>
                            {% endif %}
                            {% if config and config.institution_cnpj_show is True %}
                                <div class="col-md-4">
                                    {% render_generic_field form.institution_cnpj required=config.institution_cnpj_required %}
                                </div>
                            {% endif %}
                            {% if config and config.function_show is True %}
                                <div class="col-md-4">
                                    {% render_generic_field form.function required=config.function_required %}
                                </div>
                            {% endif %}
                        </div>

                    </div>
                </div>
                {% if config and config.address == config.ADDRESS_SHOW %}
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="panel-title">
                                Endereço
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-3">
                                    {% render_generic_field form.zip_code %}
                                    <div id="cep_loader" style="width: 22px;position: absolute;top: 32px;right: 31px;">
                                        <img src="{% static 'assets/img/loader.gif' %}"/>
                                    </div>
                                </div>
                            </div>
                            <div class="row address-row">
                                <div class="col-md-9">
                                    {% render_generic_field form.street %}
                                </div>
                                <div class="col-md-3 address-row">
                                    {% render_generic_field form.number %}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 address-row">
                                    {% render_generic_field form.complement %}
                                </div>
                                <div class="col-md-6 address-row">
                                    {% render_generic_field form.village %}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 address-row">
                                    {% render_generic_field form.state required=True %}
                                </div>
                                <div class="col-md-9 address-row">
                                    {% render_generic_field form.city_name required=True %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div class="row">
            <div class="col-md-12">
                <div class="buttonbar bottom">
                    <div class="float-right">
                        <a href="{% url 'subscription:subscription-list' event.pk %}"
                           class="btn btn-danger">
                            <i class="fas fa-times-circle"></i>
                            Cancelar
                        </a>

                        <button type="submit" class="btn btn-success">
                            <i class="fa fa-save"></i>
                            Salvar
                        </button>
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
        </div>
    </form>
{% endblock %}

