{% extends "base/base.html" %}
{# @TODO Change the icons in nav_aside_itens  #}
{% load static %}
{% load base_tags %}
{% load subscription_tags %}

{% block title %} Lotes | Congressy{% endblock %}

{% block page_title %}Lotes/Categorias{% endblock %}

{% block page_sub_title %}
    {{ event.name }}
{% endblock %}

{% block styles %}
    <style>
        ul.block-list li:hover {
            background: #f5f5f5;
        }
        ul.block-list li.active {
            background-color: #337ab7;
        }
        ul.block-list li .list-icons .well {
            padding: 3px !important;
            margin-bottom: 0;
        }
        ul.block-list li .list-icons .well:hover {
            background-color: #DDD;
        }
        .tab-wrapper .tab-content div.active {
            outline: none;
        }
    </style>

    {% if object_list %}
    <link rel="stylesheet"
          href="{% static 'assets/plugins/dataTables/css/dataTables.css' %}">
    {% endif %}
{% endblock %}

{% block scripts %}
    <script src="{% static 'assets/js/lot.js' %}"></script>
    <script>
    $(document).ready(function() {
        selectFromHash();
        createAnchorEvents();
    });
    </script>

    {% if object_list %}
    <script src="{% static 'assets/plugins/dataTables/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'assets/plugins/dataTables/js/dataTables.bootstrap.js' %}"></script>
    <script>
        $(document).ready(function () {
            $('#lot_table').DataTable({
                "language": {
                    sEmptyTable: "Nenhum registro encontrado",
                    sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                    sInfoEmpty: "Mostrando 0 até 0 de 0 registros",
                    sInfoFiltered: "(Filtrados de _MAX_ registros)",
                    sInfoPostFix: "",
                    sInfoThousands: ".",
                    sLengthMenu: "_MENU_ resultados por página",
                    sLoadingRecords: "Carregando...",
                    sProcessing: "Processando...",
                    sZeroRecords: "Nenhum registro encontrado",
                    sSearch: "Pesquisar",
                    oPaginate: {
                        sNext: "Próximo",
                        sPrevious: "Anterior",
                        sFirst: "Primeiro",
                        sLast: "Último"
                    },
                    oAria: {
                        sSortAscending: ": Ordenar colunas de forma ascendente",
                        sSortDescending: ": Ordenar colunas de forma descendente"
                    }
                },
                "columnDefs": [
                    // Disable sort in first, last column
                    {
                        "searchable": false,
                        "orderable": false,
                        "width": "3%",
                        "className": "text-center",
                        "targets": [-1]
                    },
                    {
                        "searchable": false,
                        "orderable": false,
                        "width": "8%",
                        "className": null,
                        "targets": [-2]
                    },
                    {
                        "targets": 0,
                        "className": "nowrap"
                    }
                ],
                // Default order
                "order": [[0, 'asc']]
            });
        });
    </script>
    {% endif %}
{% endblock %}

{% block nav_aside_itens %}
    <h5 class="sidebar-header">Participantes</h5>
    <ul class="nav nav-pills nav-stacked">
        <li class="active">
            <a href="{% url 'subscription:lot-list' event.pk %}"
               title="Inscrições">
                <i class="fa  fa-fw fa-rocket"></i>
                Lotes/Categorias
            </a>
        </li>
        <li>
            <a href="{% url 'subscription:subscription-list' event.pk %}"
               title="Inscrições">
                <i class="fa  fa-fw fa-rocket"></i>
                Inscrições
                <span class="badge float-right">{% event_count_completed_subscriptions event %}</span>
            </a>
        </li>
        {#        <li>#}
        {#            <a href="{% url 'subscription:subscription-attendance-search' event.pk %}"#}
        {#               title="Check-in">#}
        {#                <i class="fa  fa-fw fa-rocket"></i>#}
        {#                Check-in#}
        {#            </a>#}
        {#        </li>#}
    </ul>
    <h5 class="sidebar-header">Configurações</h5>
    <ul class="nav nav-pills nav-stacked">
        <li>
            <a href="{% url 'event:event-hotsite' event.pk %}"
               title="Página do evento">
                <i class="fa  fa-fw fa-rocket"></i> Página do evento
            </a>
        </li>
        <li>
            <a href="{% url 'subscription:form-config' event.pk %}"
               title="Formulário">
                <i class="fa  fa-fw fa-rocket"></i> Formulário
            </a>
        </li>
        <li>
            <a href="{% url 'addon:optional-service-list' event.pk %}"
               title="Atividades Extras">
                <i class="fa  fa-fw fa-rocket"></i> Atividades Extras
            </a>
        </li>
        <li>
            <a href="{% url 'addon:optional-product-list' event.pk %}"
               title="Venda de Produtos">
                <i class="fa  fa-fw fa-rocket"></i> Venda de Produtos
            </a>
        </li>
        {% if has_paid_lots %}
            <li>
                <a href="{% url 'payment:event-payments' event.pk %}"
                   title="Pagamentos">
                    <i class="fa  fa-fw fa-rocket"></i> Pagamentos
                </a>
            </li>
        {% endif %}

    </ul>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12 col-xl-8 col-xl-push-2">
            <div class="row">
                <div class="col-md-12">
                    <div class="buttonbar">
                        <div class="float-left">
                            <a href="{% url 'subscription:category-list' event.pk %}"
                                class="btn btn-primary">
                                <i class="fab fa-stack-exchange"></i>
                                Gerenciar Categorias
                            </a>
                            <a href="{% url 'subscription:lot-add' event.pk %}"
                                class="btn btn-success">
                                <i class="fa fa-plus"></i>
                                Novo Lote
                            </a>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>

            {% if categories.count %}
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="panel-title">
                                Gerenciamento de Lotes por Categoria
                            </div>
                        </div>
                        <div class="panel-body" id="lot-list-main-block">
                            {% include 'lot/categories-lots-list.html' %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {# LEGACY - LOTES SEM CATEGORIA #}
            {% if object_list %}
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-primary">
                        <div class="panel-body">
                            <table id="lot_table"
                                   class="table table-striped table-bordered dataTable no-footer nowrap"
                                   cellspacing="0"
                                   width="100%">
                                <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th class="hidden-xs hidden-sm">Tipo</th>
                                    <th class="hidden-xs hidden-sm">Inscrições</th>
                                    <th>Preço</th>
                                    <th>Código</th>
                                    <th></th>
                                </tr>
                                </thead>

                                <tbody>
                                {% for lot in object_list %}
                                    {% if lot.status == lot.LOT_STATUS_RUNNING %}
                                        <tr class="success">
                                            {% elif lot.status == lot.LOT_STATUS_FINISHED %}
                                        <tr class="danger">
                                            {% else %}
                                        <tr>
                                    {% endif %}

                                <td>
                                    {% if lot.rsvp_restrict %}
                                        <div>
                                            <span class="badge badge-primary">Associados</span>
                                        </div>
                                    {% endif %}

                                    {% if user has 'gatheros_subscription.change_lot' of lot %}
                                        <a href="{% url 'subscription:lot-edit' event.pk lot.pk %}">{{ lot.name }}</a>
                                    {% else %}
                                        {{ lot.name }}
                                    {% endif %}
                                    <br />
                                    <small class="text-muted">{{ lot.get_period }}</small>
                                </td>

                                <td class="hidden-xs hidden-sm">{% if lot.price and lot.price > 0 %}
                                    Pago{% else %}Gratuito{% endif %}</td>


                                <td class="hidden-xs hidden-sm">
                                    {% lot_count_completed_subscriptions lot %}
                                    {% if lot.limit %}
                                        / {{ lot.limit }}
                                        vagas
                                        <span style="color:dimgray">(limitadas)</span>
                                    {% else %}
                                        vagas
                                        <span style="color:dimgray">(aberto)</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lot.price and lot.price > 0 %}
                                        {{ lot.display_publicly }}
                                    {% else %}
                                        ----
                                    {% endif %}
                                </td>
                                <td class="hidden-xs">

                                    {% if lot.private %}
                                        <div>
                                            <span class="badge badge-primary">Privado</span>
                                        </div>
                                        <div>
                                            {{ lot.exhibition_code|default_if_none:'' }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button
                                            type="button"
                                            class="btn
                                            btn-primary btn-trans
                                            btn-sm dropdown-toggle"
                                            data-toggle="dropdown"
                                            aria-expanded="false">
                                            <span class="fas fa-cog"></span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-right"
                                            role="menu">
                                            {% if user has 'gatheros_subscription.change_lot' of lot %}
                                                <li>
                                                    <a href="{% url 'subscription:lot-edit' event.pk lot.pk %}">
                                                        <i class="fas fa-pencil-alt"></i>
                                                        Editar
                                                    </a>
                                                </li>
                                            {% endif %}
                                            {% if lot.is_deletable and user has 'gatheros_subscription.delete_lot' of lot %}
                                                <li>
                                                    <a href="{% url 'subscription:lot-delete' event.pk lot.pk %}">
                                                        <i class="fas fa-trash-alt"></i>
                                                        Excluir
                                                    </a>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>


                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            {% endif %}
        </div>
    </div>

    <!-- Lot survey Modal -->
    <div class="modal fade" id="survey-lot-form" tabindex="-1" role="dialog" aria-labelledby="survey-lot-form-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="survey-lot-form-title">Gerenciar Formulário Personalizado</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form" onsubmit="save_survey();return false;">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label for="lot-survey">Formulários:</label>
                                <div>
                                    <select name="lot-survey" id="lot-survey" class="form-control">
                                        <option value="">- Sem formulário -</option>
                                        {% for event_survey in event.surveys.all %}
                                            <option value="{{ event_survey.pk }}">{{ event_survey }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <small class="text-muted help-text">
                                        Exibir o formulário selecionado para o lote <strong id="survey-lot-name"></strong>.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="save_survey();">Vincular formulário</button>
                    <input type="hidden" name="survey-lot_id" id="survey-lot_id" value="" />
                </div>
            </div>
        </div>
    </div>
    <!-- / Lot survey Modal -->

    <!-- Lot Limit Modal -->
    <div class="modal fade" id="lot-limit-form" tabindex="-1" role="dialog" aria-labelledby="lot-limit-form-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="lot-limit-form-title">Gerenciar Limite de Vagas</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form" onsubmit="save_limit();return false;">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label for="lot-survey">Limite de Vagas:</label>
                                <div>
                                    <input type="number" min="0" class="form-control" name="lot-limit" id="lot-limit" value="" />
                                </div>
                                <div>
                                    <small class="text-muted help-text">
                                        Exibir o formulário selecionado para o lote <strong id="lot-limit-name"></strong>.
                                        Caso queira deixar ilimitado, infome <strong>0</strong>.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="save_limit()">Salvar Limite de Vagas</button>
                    <input type="hidden" name="lot-limit-lot_id" id="lot-limit-lot_id" value="" />
                </div>
            </div>
        </div>
    </div>
    <!-- / Lot Limit Modal -->
        
    <!-- Lot Privacy Modal -->
    <div class="modal fade" id="lot-privacy_form" tabindex="-1" role="dialog" aria-labelledby="lot-privacy_form-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="lot-privacy_form-title">Gerenciar Privacidade</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form" onsubmit="save_privacy();return false;">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label for="lot-privacy_private">Privado:</label>
                                <div>
                                    <input
                                        type="checkbox"
                                        name="lot-privacy_private"
                                        id="lot-privacy_private"
                                        style="display:none"
                                        class="js-switch" />
                                </div>
                                <div>
                                    <small class="text-muted help-text">
                                        Configurar privacidade do lote <strong id="lot-privacy_name"></strong>.
                                    </small>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <label for="lot-survey">Cupom:</label>
                                <div>
                                    <input
                                        type="text"
                                        name="lot-privacy_exhibition-code"
                                        value=""
                                        maxlength="15"
                                        class="form-control"
                                        id="lot-privacy_exhibition-code">
                                </div>
                                <div class="text-muted">
                                    O lote estará disponível através do cupom utilizado.
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="save_privacy()">Salvar Privacidade</button>
                    <input type="hidden" name="lot-privacy-lot_id" id="lot-privacy-lot_id" value="" />
                </div>
            </div>
        </div>
    </div>
    <!-- / Lot Privacy Modal -->



{% endblock %}
