{% extends "base/base.html" %}
{# @TODO Change the icons in nav_aside_itens  #}
{% load static %}
{% load base_tags %}

{% block title %} Lotes | Congressy{% endblock %}

{% block page_title %}Lotes/Categorias{% endblock %}

{% block page_sub_title %}
    {{ event.name }}
{% endblock %}

{% block styles %}
    <style>
        ul.block-list li:hover {
            background: #f5f5f5;
            cursor: pointer;
        }
        ul.block-list li.active {
            background-color: #337ab7;
        }
        ul.block-list li .list-icons .well {
            padding: 3px !important;
            margin-bottom: 0;
        }
        ul.block-list li .list-icons .well:hover {
            background-color: #DDD;
        }
        .tab-wrapper .tab-content div.active {
            outline: none;
        }
    </style>
{% endblock %}

{% block scripts %}
    <script src="{% static 'assets/js/lot.js' %}"></script>
    <script>
    $(document).ready(function () {
        Messenger.options = {
            extraClasses: 'messenger-fixed messenger-on-bottom ' +
            'messenger-on-right',
            theme: 'flat'
        };
    });

    function save_survey() {
        var data = {
            'event_survey': 2
        };
        save_lot('/api/lots/7', data, 'Formulário vinculado ao lote com sucesso!');
    }
    function save_limit() {
        var data = {
            'limit': 300
        };
        save_lot('/api/lots/7', data, 'Limite de vagas configurado com sucesso!');
    }
    function save_privacy() {
        var data = {
            'private': true,
            'exhibition_code': 'aaaaaaa'
        };
        save_lot('/api/lots/7', data, 'Privacidade de lote configurada com sucesso!');
    }
    function selectFromHash() {
        var hash = window.location.hash.substring(1)
        var cat_id = hash.replace('cat=', '');
        if (cat_id) {
            select(cat_id)
        }
    }

    function select(cat_id) {
        $('.nav-tabs').find('li').removeClass('active');
        $('.tab-pane').removeClass('active');

        $('#cat-super-' + cat_id).addClass('active');
        $('#cat-' + cat_id).addClass('active');
        window.location.hash='#cat='+cat_id;
    }

    $(document).ready(function() {
        selectFromHash();
    });
    </script>
{% endblock %}

{% block nav_aside_itens %}{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12 col-xl-8 col-xl-push-2">
            <div class="row">
                <div class="col-md-12">
                    <div class="buttonbar">
                        <div class="float-left">
                            <a href="{% url 'subscription:category-list' event.pk %}"
                                class="btn btn-primary">
                                <i class="fab fa-stack-exchange"></i>
                                Gerenciar Categorias
                            </a>
                            <a href="{% url 'subscription:lot-add' event.pk %}"
                                class="btn btn-success">
                                <i class="fa fa-plus"></i>
                                Novo Lote
                            </a>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="panel-title">
                                Gerenciamento de Lotes por Categoria
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="tab-wrapper tab-left ">
                                        <ul class="nav nav-tabs">
                                            {% for cat in event.lot_categories.all %}
                                            <li id="cat-super-{{ cat.pk }}" class="{% if forloop.counter0 == 0 %}active{% endif %}" style="width:180px;overflow: hidden">
                                                <a href="#cat-{{ cat.pk }}" data-toggle="tab" aria-expanded="{% if forloop.counter0 == 0 %}true{% else %}false{% endif %}">
                                                    {{ cat.name }}
                                                </a>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                        <div class="tab-content">
                                            {% for cat in event.lot_categories.all %}
                                            <div class="tab-pane {% if forloop.counter0 == 0 %}active{% endif %}" id="cat-{{ cat.pk }}">
                                                <h3 style="font-weight: bold;padding: 10px 0">{{ cat.name }}</h3>
                                                <hr />
                                                {% if cat.lots.count %}
                                                <ul class="list-group block-list">
                                                    {% for lot in cat.lots.all %}
                                                    <li class="list-group-item">
                                                        <div class="row tooltip-wrapper">
                                                            <div class="col-md-8 col-lg-7 col-xl-8" style="word-wrap: break-word">
                                                                <div class="panel-title">
                                                                    {{ lot.get_period }}
                                                                </div>
                                                                <hr />
                                                                <div style="margin-bottom:3px;">
                                                                    <div class="float-left">
                                                                        {{ lot.name }}
                                                                    </div>
                                                                    <div class="float-right">
                                                                    {% if lot.price %}
                                                                        <div style="font-size:14px" class="badge badge-primary">R$ {{ lot.get_calculated_price }}</div>
                                                                    {% endif %}
                                                                    </div>
                                                                    <div class="clearfix"></div>
                                                                </div>

                                                                {% if lot.status == lot.LOT_STATUS_RUNNING %}
                                                                    <div class="badge badge-success">Andamento</div>
                                                                {% elif lot.status == lot.LOT_STATUS_FINISHED %}
                                                                    <div class="badge badge-warning">Finalizado</div>
                                                                {% else %}
                                                                    <div class="badge">Não-iniciado</div>
                                                                {% endif %}
                                                                {% if lot.private %}
                                                                    <div class="badge badge-primary">Privado</div>
                                                                {% endif %}
                                                                {% if lot.event_survey %}
                                                                    <div class="badge badge-primary">{{ lot.event_survey }}</div>
                                                                {% endif %}
                                                                {% if not full_banking %}
                                                                <br />
                                                                <a href="{% url 'event:organization-financial-edit' organization.pk %}" class="btn btn-link btn-sm btn-danger">
                                                                    <i class="fas fa-exclamation-triangle"></i>
                                                                    Você não inseriu dados bancários.
                                                                </a>
                                                                {% endif %}
                                                                <hr />
                                                                <div style="margin-bottom:3px;">
                                                                    Inscrições:
                                                                    <span style="font-weight: bold;">
                                                                        {{ subscription_stats.num|lookup:lot.pk }}
                                                                        {% if not lot.limit %}(ilimitado){% endif %}
                                                                    </span>
                                                                </div>
                                                                {% if lot.limit %}
                                                                <div style="margin-bottom:3px;">
                                                                    Vagas disponíveis: <span style="font-weight: bold;"><span style="font-weight: bold;">{{ subscription_stats.remaining|lookup:lot.pk }}</span></span>
                                                                </div>
                                                                {% endif %}
                                                                {% if lot.private %}
                                                                <div style="margin-bottom:3px;">
                                                                    Cupom: <span style="font-weight: bold;">{{ lot.exhibition_code|default_if_none:'-' }}</span>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-md-2 col-lg-3 col-xl-2">
                                                                <hr class="hidden-md hidden-lg hidden-xl" />
                                                                <div
                                                                    data-toggle="tooltip"
                                                                    data-placement="left"
                                                                    title=""
                                                                    data-original-title="Gerenciar Formulário personalizado">
                                                                    <button
                                                                        class="btn btn-sm btn-info btn-block {% if not lot.event_survey %}btn-trans{% endif %}"
                                                                        data-toggle="modal"
                                                                        data-backdrop="static"
                                                                        onclick="$('#survey-lot_id').val('{{ lot.pk }}');$('#survey-lot-name').text('{{ lot.name }}');$('#lot-survey').val('{{ lot.event_survey_id|default_if_none:'' }}')"
                                                                        data-target="#survey-lot-form">
                                                                        <i class="fas fa-list"></i>
                                                                        <span class="hidden-md">Formulário</span>
                                                                    </button>
                                                                </div>
                                                                <div
                                                                    data-toggle="tooltip"
                                                                    data-placement="left"
                                                                    title=""
                                                                    data-original-title="Gerenciar limite de vagas">
                                                                    <button
                                                                        class="btn btn-sm btn-info btn-block {% if not lot.limit %}btn-trans{% endif %}"
                                                                        data-toggle="modal"
                                                                        data-backdrop="static"
                                                                        onclick="$('#lot-limit-lot_id').val('{{ lot.pk }}');$('#lot-limit-name').text('{{ lot.name }}');$('#lot-limit').val('{{ lot.limit|default_if_none:0 }}')"
                                                                        data-target="#lot-limit-form">
                                                                        <i class="fas fa-users"></i>
                                                                        <span class="hidden-md">Vagas</span>
                                                                    </button>
                                                                </div>
                                                                <div
                                                                    data-toggle="tooltip"
                                                                    data-placement="left"
                                                                    title=""
                                                                    data-original-title="Gerenciar privacidade">
                                                                    <button
                                                                        class="btn btn-sm btn-info btn-block {% if not lot.private %}btn-trans{% endif %}"
                                                                        data-toggle="modal"
                                                                        data-backdrop="static"
                                                                        onclick="$('#lot-privacy-lot_id').val('{{ lot.pk }}');$('#lot-privacy_name').text('{{ lot.name }}');app.setSwitchery('#lot-privacy_private', {% if lot.private %}true{% else %}false{% endif %});$('#lot-privacy_exhibition-code').val('{{ lot.exhibition_code|default_if_none:exhibition_code }}')"
                                                                        data-target="#lot-privacy_form">
                                                                        <i class="fas fa-lock"></i>
                                                                        <span class="hidden-md">Privacidade</span>
                                                                    </button>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-2">
                                                                {% if user has 'gatheros_subscription.change_lot' of lot %}
                                                                <div
                                                                    data-toggle="tooltip"
                                                                    data-placement="left"
                                                                    title=""
                                                                    data-original-title="Editar">
                                                                    <button
                                                                       onclick="window.location.href='{% url 'subscription:lot-edit' event.pk lot.pk %}'"
                                                                       class="btn btn-sm btn-primary btn-trans btn-block"
                                                                       data-target="#lot-form">
                                                                       <i class="fa fa-pencil-alt"></i>
                                                                    </button>
                                                                </div>
                                                                {% endif %}
                                                                {% if lot.active %}
                                                                <div
                                                                    data-toggle="tooltip"
                                                                    data-placement="left"
                                                                    title=""
                                                                    data-original-title="Este lote está ativo. Clique para desativa-lo.">
                                                                    <button
                                                                        class="btn btn-sm btn-success btn-trans btn-block">
                                                                        <i class="fas fa-check-circle"></i>
                                                                    </button>
                                                                </div>
                                                                {% else %}
                                                                <div
                                                                    data-toggle="tooltip"
                                                                    data-placement="left"
                                                                    title=""
                                                                    data-original-title="Este lote está inativo. Clique para ativa-lo.">
                                                                    <button
                                                                        class="btn btn-sm btn-warning btn-trans btn-block">
                                                                        <i class="fa fa-exclamation-circle"></i>
                                                                    </button>
                                                                </div>
                                                                {% endif %}
                                                                {% if lot.is_deletable and user has 'gatheros_subscription.delete_lot' of lot %}
                                                                <div
                                                                    data-toggle="tooltip"
                                                                    data-placement="left"
                                                                    title=""
                                                                    data-original-title="Excluir">
                                                                    <button class="btn btn-sm btn-default btn-trans btn-block"
                                                                        onclick="window.location.href='{% url 'subscription:lot-delete' event.pk lot.pk %}'">
                                                                        <i class="fas fa-trash-alt"></i>
                                                                    </button>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                    <div style="padding: 40px 20px">
                                                    Não há lotes nesta categoria.
                                                    </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Lot survey Modal -->
    <div class="modal fade" id="survey-lot-form" tabindex="-1" role="dialog" aria-labelledby="survey-lot-form-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="survey-lot-form-title">Gerenciar Formulário Personalizado</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label for="lot-survey">Formulários:</label>
                                <div>
                                    <select name="lot-survey" id="lot-survey" class="form-control">
                                        <option value="">- Sem formulário -</option>
                                        {% for event_survey in event.surveys.all %}
                                            <option value="{{ event_survey.pk }}">{{ event_survey }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <small class="text-muted help-text">
                                        Exibir o formulário selecionado para o lote <strong id="survey-lot-name"></strong>.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary">Vincular formulário</button>
                    <input type="hidden" name="survey-lot_id" id="survey-lot_id" value="" />
                </div>
            </div>
        </div>
    </div>
    <!-- / Lot survey Modal -->

    <!-- Lot Limit Modal -->
    <div class="modal fade" id="lot-limit-form" tabindex="-1" role="dialog" aria-labelledby="lot-limit-form-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="lot-limit-form-title">Gerenciar Limite de Vagas</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label for="lot-survey">Limite de Vagas:</label>
                                <div>
                                    <input type="number" min="0" class="form-control" name="lot-limit" id="lot-limit" value="" />
                                </div>
                                <div>
                                    <small class="text-muted help-text">
                                        Exibir o formulário selecionado para o lote <strong id="lot-limit-name"></strong>.
                                        Caso queira deixar ilimitado, infome <strong>0</strong>.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary">Salvar Limite de Vagas</button>
                    <input type="hidden" name="lot-limit-lot_id" id="lot-limit-lot_id" value="" />
                </div>
            </div>
        </div>
    </div>
    <!-- / Lot Limit Modal -->
        
    <!-- Lot Privacy Modal -->
    <div class="modal fade" id="lot-privacy_form" tabindex="-1" role="dialog" aria-labelledby="lot-privacy_form-title" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="lot-privacy_form-title">Gerenciar Privacidade</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label for="lot-privacy_private">Privado:</label>
                                <div>
                                    <input
                                        type="checkbox"
                                        name="lot-privacy_private"
                                        id="lot-privacy_private"
                                        style="display:none"
                                        class="js-switch" />
                                </div>
                                <div>
                                    <small class="text-muted help-text">
                                        Configurar privacidade do lote <strong id="lot-privacy_name"></strong>.
                                    </small>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <label for="lot-survey">Cupom:</label>
                                <div>
                                    <input
                                        type="text"
                                        name="lot-privacy_exhibition-code"
                                        value=""
                                        maxlength="15"
                                        class="form-control"
                                        id="lot-privacy_exhibition-code">
                                </div>
                                <div class="text-muted">
                                    O lote estará disponível através do cupom utilizado.
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary">Salvar privacye de Vagas</button>
                    <input type="hidden" name="lot-privacy-lot_id" id="lot-privacy-lot_id" value="" />
                </div>
            </div>
        </div>
    </div>
    <!-- / Lot Privacy Modal -->



{% endblock %}
