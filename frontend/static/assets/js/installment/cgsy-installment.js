window.cgsy=window.cgsy||{},window.cgsy.installment=window.cgsy.installment||{},window.cgsy.installment.component=window.cgsy.installment.component||{},function(t,a,n,e,o){"use strict";n.component.ContractFormModal=function(r,l,s,d){a.modal.Modal.call(this,l);var i=this;i.dom_manager.domElements["num-installments-field"]=null,i.dom_manager.domElements["expiration-day-field"]=null,i.dom_manager.domElements["part-table-list"]=null,i.dom_manager.domElements.limit_date_field=null,this.form=new window.cgsy.installment.form.ContractForm(r,s),this.form.setEl("button",t(d)),i.form.button_text="Criar contrato",i.form.addPostSaveCallback(function(){var t=new a.messenger.Messenger;t.notifyLoader(),window.location.reload(!0)}),i.loadElement(s),i.setTitle("NOVO CONTRATO DE PARCELAMENTO"),this.populate=function(a){var r=a.limit_date_str;if(!e(r).isValid())throw"Data limite inválida: "+r;r=r.split("-"),r=new Date(r[0],r[1]-1,r[2]),i.getEl("limit_date_field").text(e(r).format("DD/MM/YYYY")),i.form.set("expiration_day",parseInt(a.expiration_day)),i.form.set("amount",o(a.amount));var l=new n.component.ContractPartsList(i.getEl("part-table-list")),s=i.getEl("expiration-day-field"),d=i.getEl("num-installments-field");d.empty(),d.unbind("change"),d.on("change",function(){m(l,t(this).val(),r,parseInt(s.val()),a.amount,a.minimum_amount),l.render(t(this).val()),i.form.syncDataAndDom()}),s.unbind("change"),s.on("change",function(){var n=t(this).val();1>n||n>31||(m(l,d.val(),r,parseInt(n),a.amount,a.minimum_amount),l.render(d.val()),i.form.syncDataAndDom())}),m(l,1,r,parseInt(a.expiration_day),a.amount,a.minimum_amount);for(var c=1;l.items.length>=c;c++)d.append(t("<option>").attr("value",c).text(c+"x"));l.render()};var m=function(t,a,n,e,r,l){t.reset();var s=c(n,e);if(s.length){var d=s.length,m=p(d,r,l);d=Object.keys(m).length;var f=u(a,m);i.form.set("part_amount",f);var g=0;s.forEach(function(a){d>g&&t.addItem(a,o(f)),g++})}},c=function(t,a){var e=new n.service.ExpirationDateGenerator(t,a);return e.getDates("DD/MM/YYYY")},p=function(t,a,e){var o=new n.service.PriceCalculator(t,a,e);return o.getAmounts()},u=function(t,a){return a.hasOwnProperty(t)?a[t]:null};window.setTimeout(function(){t("[name=expiration_day]",s).focus()},250)},n.component.ContractFormModal.prototype=Object.create(a.modal.Modal.prototype),n.component.ContractFormModal.prototype.constructor=n.component.ContractFormModal,n.component.ContractPartsList=function(n){a.dom.Component.call(this);var e=this;this.parent_el=t(n),this.items=[],this.addItem=function(t,a){e.items.push({expiration_date_str:t,amount:a})},this.reset=function(){e.items=[]},this.render=function(a){a=a||1;var n=t("<table>").addClass("table borderless"),r=t("<tr>");n.append(r),r.append(t("<td>").addClass("col-xs-1 col-sm-3 col-md-3 col-lg-2 text-right").append(t("<small>").text("Parcela"))),r.append(t("<td>").addClass("col-xs-3 col-sm-2 col-md-2 col-lg-3 text-center").append(t("<small>").text("Valor"))),r.append(t("<td>").addClass("col-xs-3 col-sm-3 col-md-4 col-lg-3").append(t("<small>").text("Vencimento")));var l=1;e.items.forEach(function(t){n.append(o(l,t.amount,t.expiration_date_str,a>=l)),l++}),e.parent_el.html(n)};var o=function(a,n,e,o){o=o===!0;var r=t("<tr>").addClass("row-amount"+a);o===!1&&r.addClass("hide");var l=t("<td>").addClass("text-right").append(t("<label>").attr("for","exp_date"+a).addClass("label-control").css("margin-bottom",0).text(a)),s=t("<td>").addClass("text-center").append(t("<label>").attr("for","exp_date"+a).addClass("label-control").css("margin-bottom",0).text("R$ "+n)),d=t("<td>").addClass("col-lg-2"),i=t("<div>").addClass("input-group");d.append(i),i.append(t("<span>").addClass("input-group-addon").append(t("<i>").addClass("fas fa-calendar-alt")));var m=t("<input>").addClass("form-control").attr("type","tel").attr("name","exp_date"+a).attr("id","exp_date"+a).attr("value",e).attr("readonly","");return m.mask("99/99/9999"),i.append(m),r.append(l),r.append(s),r.append(d),r}},n.component.ContractPartsList.prototype=Object.create(a.dom.Component.prototype),n.component.ContractPartsList.prototype.constructor=n.component.ContractPartsList}(jQuery,window.cgsy.abstracts,window.cgsy.installment,moment,as_currency);window.cgsy=window.cgsy||{},window.cgsy.installment=window.cgsy.installment||{},function(t,e){"use strict";e.models={};var o=new t.uri.APIBaseUrl("/api/","/api/"),n=new t.uri.URIManager(o,"/installment");e.models.Contract=function(o){t.domain.Model.call(this,o&&o>0?parseInt(o):void 0);var i=this;this.verbose_name="contrato de parcelamento",this.verbose_name_plural="contratos de parcelamento",this.uri_manager=n,this.creation_uri="/contracts/",this.uri="/contracts/{{pk}}/",this.part_collection=null,this.fields={subscription:{required:!0,type:"string",submittable:!0,blank:!0,label:"Inscrição",message:"Você deve informar a inscrição"},amount:{required:!0,type:"float",submittable:!0,label:"Valor",message:"Você deve informar o valor"},num_installments:{required:!0,type:"integer",submittable:!0,label:"Quantidade de Parcelas",message:"Você deve a quantidade de parcelas"},expiration_day:{required:!0,submittable:!0,label:"Dia base de vencimento",type:"integer",message:"Você deve informar o dia base de vencimento"},status:{required:!1,submittable:!1,label:"Status",type:"string"}},this.createPartCollection=function(){return i.isNew()?(i.part_collection=null,void 0):(i.part_collection=new e.collections.PartCollection(i.pk),i.part_collection.error_handler=i.error_handler,i.part_collection)},this.fetchParts=function(){return i.isNew()?new Promise(function(t){t()}):new Promise(function(t,e){return i.createPartCollection(),i.part_collection?(i.part_collection.fetch().then(function(){return i.part_collection.isValid()?(t(),void 0):(e(i.error_handler),void 0)}),void 0):(e(),void 0)})}},e.models.Contract.prototype=Object.create(t.domain.Model.prototype),e.models.Contract.prototype.constructor=e.models.Contract,e.collections={},e.collections.ContractCollection=function(o){t.domain.Collection.call(this),o||console.warn("Nenhum UUID de inscrição informada."),this.model_class=e.models.Contract,this.uri_manager=n,this.uri="/contracts/?subscription="+o,this.addUriFilter=function(t,e){self.uri+="&{}={}".format(t,e)}},e.collections.ContractCollection.prototype=Object.create(t.domain.Collection.prototype),e.collections.ContractCollection.prototype.constructor=e.collections.ContractCollection}(window.cgsy.abstracts,window.cgsy.installment);window.cgsy=window.cgsy||{},window.cgsy.installment=window.cgsy.installment||{},window.cgsy.installment.form=window.cgsy.installment.form||{},function(t,n){"use strict";n.form.ContractForm=function(o,r){t.form.Form.call(this,r);var e=this;e.strictModeOff(),this.subscription_pk=o,this.afterSaveCallback=function(){},this.setAfterSaveCallback=function(t){typeof t!="function"&&(e.afterSaveCallback=t)},this.postSave=function(){window.setTimeout(function(){e.disableSubmitButton()},100)},this.saveHandler=function(){return new Promise(function(o,r){var i=new n.models.Contract;i.set("subscription",e.subscription_pk);for(var a=new t.form.FormErrorAlerter(e.alerter_el,i.error_handler),s=e.getData(),c=[],l=1;s.num_installments>=l;l++){var f="exp_date"+l;c.push(s[f]),delete s[f]}var m=s.part_amount,u=m.split(",");return m=parseFloat(u.join(".")),delete s.part_amount,i.populate(s),i.isValid()?(i.save().then(function(){if(!i.isValid())return a.notify(),r();var t=new n.service.PartCollectionFactory(i);t.create(c,m).then(function(){o()},function(t){r(t)})},function(t){r(t)}),void 0):(a.notify(),r())})}},n.form.ContractForm.prototype=Object.create(t.form.Form.prototype),n.form.ContractForm.prototype.constructor=n.form.ContractForm}(window.cgsy.abstracts,window.cgsy.installment);window.cgsy=window.cgsy||{},window.cgsy.installment=window.cgsy.installment||{},window.cgsy.installment.component=window.cgsy.installment.component||{},function(t,n,e){"use strict";n.component.PartTable=function(n,a){t.dom.Component.call(this),t.element.list.Table.call(this,n);var o=this;o.dom_manager.domElements["cancel-button"]=null,this.preRender=function(){var t=o.getEl("cancel-button");t&&t.length&&t.hide()},this.postRender=function(){var n=o.getEl("cancel-button");n&&n.length&&(n.show(),n.unbind("click"),n.on("click",function(){var n=new t.messenger.Messenger("deleting-contract");confirm("Tem certeza que deseja cancelar este contrato?")&&(n.notifyLoader(),a.set("status","cancelled"),a.save().then(function(){n.notifySuccess("Contrato cancelado com sucesso."),n.id=null,n.notifyLoader(),window.location.reload(!0)},function(){n.notifyError("Houve um erro ao cancelar contrato.")}))}))},o.addHeader("#","# Parcela","text-center","12%"),o.addHeader("exp_date","Vencimento","text-center",null),o.addHeader("amount","Valor (R$)","text-center","25%"),o.addHeader("status","Status","text-center","10%"),o.addColumnHandler("#",function(t){var n=t.get("paid")===!0,e=t.next===!0,a=t.get("installment_number");return r(n,e,a)}),o.addColumnHandler("exp_date",function(t){var n=t.get("paid")===!0,e=t.next===!0,a=t.get("expiration_date").format("DD/MM/YYYY");return r(n,e,a)}),o.addColumnHandler("amount",function(t){var n=t.get("paid")===!0,a=t.next===!0,o="R$ "+e(t.get("amount"));return r(n,a,o)}),o.addColumnHandler("status",function(t){var n=t.get("paid")===!0,e=t.next===!0,a=$("<button>").addClass("btn btn-sm btn-block");return n===!0?a.addClass("btn-success").attr("disabled","").text("Pago"):n===!1&&e===!0?(a.addClass("btn-primary").attr("data-toggle","tooltip").attr("title","Registrar o pagamento").html($("<span>").addClass("far fa-money-bill-alt")),a.on("click",function(){$("#id_part").val(t.pk);var n=t.get("amount");$("#manual-payment-parts-form-modal").find("#id_amount").val(n.toFixed(2)),$("#manual-payment-parts-form-modal").modal("show")})):n===!1&&e===!1&&a.addClass("btn-default invisible").text("-"),a});var r=function(t,n,e){var a=$("<span>").text(e);return t===!0?a.addClass("text-muted text-line-through"):n===!0&&a.addClass("text-bold danger-color"),a}},n.component.ContractFormModal.prototype=Object.create(t.element.list.Table.prototype),n.component.ContractFormModal.prototype.constructor=n.component.ContractFormModal}(window.cgsy.abstracts,window.cgsy.installment,as_currency);window.cgsy=window.cgsy||{},window.cgsy.installment=window.cgsy.installment||{},window.cgsy.installment.models=window.cgsy.installment.models||{},window.cgsy.installment.collection=window.cgsy.installment.collection||{},function(t,e){"use strict";var o=new t.uri.APIBaseUrl("/api/","/api/"),a=new t.uri.URIManager(o,"/installment");e.models.Part=function(e){t.domain.Model.call(this,e&&e>0?parseInt(e):void 0),this.verbose_name="parcela",this.verbose_name_plural="parcelas",this.next=!1,this.uri_manager=a,this.creation_uri="/parts/",this.uri="/parts/{{pk}}/",this.fields={contract:{required:!0,type:"integer",submittable:!0,blank:!0,label:"Contrato",message:"Você deve informar o contrato"},amount:{required:!0,type:"float",submittable:!0,label:"Valor",message:"Você deve informar o valor"},expiration_date:{required:!0,type:"date",submittable:!0,label:"Data de vencimento",message:"Você deve a data de vencimento"},installment_number:{required:!0,type:"integer",submittable:!0,label:"Número da parcela",message:"Você deve o número da parcela"},paid:{required:!1,type:"boolean",submittable:!0,label:"Pago"}}},e.models.Part.prototype=Object.create(t.domain.Model.prototype),e.models.Part.prototype.constructor=e.models.Part,e.collections.PartCollection=function(o){t.domain.Collection.call(this);var n=this;o||console.warn("Nenhum ID de contrato informada."),this.model_class=e.models.Part,this.uri_manager=a,this.uri="/contracts/"+o+"/parts/",this._post_add=function(){r(),i()},this._post_remove=function(){r(),i()};var i=function(){n.items.forEach(function(t){t.next=!1});var t=n.items.filter(function(t){return t.get("paid")===!1});if(t.length===0)return n.items[0].next=!0,void 0;var e=t[0];e.next=!0},r=function(){function t(t,e){var o=0;return t.get("expiration_date")>e.get("expiration_date")?o=1:e.get("expiration_date")>t.get("expiration_date")&&(o=-1),o}n.items.sort(t)}},e.collections.PartCollection.prototype=Object.create(t.domain.Collection.prototype),e.collections.PartCollection.prototype.constructor=e.collections.PartCollection}(window.cgsy.abstracts,window.cgsy.installment);window.cgsy=window.cgsy||{},window.cgsy.installment=window.cgsy.installment||{},window.cgsy.installment.service=window.cgsy.installment.part||{},function(t,n){"use strict";n.service.PriceCalculator=function(t,n,a){var e=this;if(!t)throw"Você deve informar o número de parcelas";this.num_parts=t,this.amount=n,this.minimum_amount=a,this.installment_amounts={},this.getAmounts=function(){return i(),e.installment_amounts};var r=!1,i=function(){if(r!==!0){if(e.num_parts>0)for(var t=1;e.num_parts>=t;t++){var n=e.amount/t;n>=e.minimum_amount&&(e.installment_amounts[t]=n)}r=!0}};window.setTimeout(function(){i()},50)},n.service.ExpirationDateGenerator=function(t,n){var a=this;if(!t)throw"Você deve informar a data limite";this.default_days=2,this.current_date=moment(new Date),this.limit=moment(t),this.base_day=n||a.current_date.clone().add(a.default_days,"days").date(),this.dates=[],this.getDates=function(t){return r(),t=t||"YYYY-MM-DD",a.dates.map(function(n){return n.format(t)})},this.getNumParts=function(){return r(),this.dates.length};var e=!1,r=function(){if(e!==!0){var t=Math.floor(moment.duration(a.limit-a.current_date).asMonths());0>t&&(t=0);for(var n=0;t>=n;n++)a.dates.push(i()),a.current_date=a.current_date.clone().add(1,"months");e=!0}},i=function(){var t=a.current_date.date(),n=a.base_day,e=a.limit.date();a.dates.length===0&&t>=a.base_day&&(n=a.current_date.clone().add(a.default_days,"days").date()),a.current_date.isSame(a.limit,"month")&&a.base_day>e&&(n=e);var r=a.current_date.endOf("month").date();return n>r&&(n=r),moment([a.current_date.year(),a.current_date.month(),n])};window.setTimeout(function(){r()},50)},n.service.PartCollectionFactory=function(t){if(t.isNew())throw"Contratos sem identificador não podem criar parcelas.";this.contract=t,this.create=function(a,e){return new Promise(function(r,i){var o=t.createPartCollection(),s=1;a.forEach(function(a){var r=a.split("/"),c={contract:t.pk,amount:e,expiration_date:new Date(r[2],r[1]-1,r[0]),installment_number:s},d=new n.models.Part;return d.populate(c),d.isValid()?(d.save().then(function(){return d.isValid()?(o.add(d),void 0):i("Erro ao salvar parcela.")},function(t){i(t)}),s++,void 0):i("Erro ao criar parcela")}),r()})}}}(window.cgsy.abstracts,window.cgsy.installment);//================================= BASE ======================================
/**
 * Resgata collection de contratos.
 * @param {string} subscription_pk
 * @returns {Promise}
 */
function fetchContracts(t){var n=new window.cgsy.installment.collections.ContractCollection(t);return new Promise(function(t,e){n.fetch().then(function(){return n.isValid()?(t(n),void 0):e("Erro ao resgatar contratos.")}).catch(function(t){console.error(t),e(t)})})}function fetchContractParts(t){return new Promise(function(n,e){t.fetchParts().then(function(){n(t.part_collection.items)}).catch(function(t){console.error(t),e(t)})})}function getContractForm(t,n,e,o,r){var a=$("#contract-form").clone();a.removeAttr("id");var c=$("#generic-modal").clone();c.removeAttr("id");var i=$(".submit-button",c),l=$("[name=num_installments]",a),s=$("[name=expiration_day]",a),m=$(".limit_date_field",a),u=$(".contract-part-table",a),f=new window.cgsy.installment.component.ContractFormModal(t,c,a,i);f.setEl("expiration-day-field",s),f.setEl("num-installments-field",l),f.setEl("part-table-list",u),f.setEl("limit_date_field",m),f.populate({expiration_day:parseInt(e),amount:0>o?-o:o,minimum_amount:r,limit_date_str:n}),f.open()}function renderPartsList(t,n){n=$(n);var e=new window.cgsy.installment.component.PartTable(n,t);e.setEl("cancel-button",$("#cancel-installment-contract")),fetchContractParts(t).then(function(t){t.forEach(function(t){e.addItem(t)}),e.render()}).catch(function(t){console.error(t)})}function getContracts(t){fetchContracts(t).then(function(t){var n=t.items.filter(function(t){return t.get("status")==="open"}),e=$("#constract-parts-list");if(n.length===0){var o=new window.cgsy.installment.component.PartTable(e);return o.render(),void 0}var r=n[0];renderPartsList(r,e)}).catch(function(t){console.error("Erro ao buscar contratos.",t)})};