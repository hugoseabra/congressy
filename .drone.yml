# Branches added globally
branches:
  include: [master, release/*, hotfix/*]

# Custom definition for cloning, adding tags and depth
clone:
  git:
    image: plugins/git
    depth: 50
    tags: true

# Steps of deploy, according to configurations and conditionals
pipeline:
  save-prod-version:
    image: indiehosters/git
    pull: true
    commands:
      - export REF_TAG=$(git for-each-ref refs/tags --sort=-taggerdate --format='%(refname)' --count=1)
      - export LAST_TAG=$(basename $${REF_TAG})
      - echo $${LAST_TAG} > last_tag
      - cat last_tag
    when:
      branch: [ hotfix/*, release/* ]

  build-prod-images:
    image: docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - |
        echo "Building latest version: `cat ./version`"
      - |
        docker build --rm \
          -t 871800672816.dkr.ecr.us-east-1.amazonaws.com/cgsy:latest \
          -f ./conf/deploy/Dockerfile .
      - |
        echo "Building tagged version: `cat ./version`"
      - |
        docker build --rm \
          -t 871800672816.dkr.ecr.us-east-1.amazonaws.com/cgsy:`cat ./last_tag` \
          -f ./conf/deploy/Dockerfile .
