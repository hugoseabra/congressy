{% extends 'hotsite/base.html' %}
{% load static user_agents user_agent_tag %}
{% load l10n humanize %}

{% block styles %}
    <style>
        .form-group {
            margin: 4px 0;
        }

        input#id_city, input#id_city_search {
            text-transform: uppercase;
        }

        .loader-box {
            width: 100%;
            position: absolute;
            top: 5%;
        }

        .loader {
            width: 47px;
            margin: 0 auto;
        }
    </style>
{% endblock %}

{% block content %}

    {% include 'hotsite/includes/2_cover_no_form.html' %}

    <!-- FORM
    ================================= -->
    <section id="about" class="about-section section">
        <div class="container">
            <h2 class="section-heading text-center">Inscrição</h2>
            <div class="about-row row">
                <div class="col-md-9 col-md-offset-2">
                    {% include 'hotsite/subscription_form.html' %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block scripts %}

    <!-- SCRIPT Subscription -->
    <script src="{% static "hotsite/js/subscription.js" %}"></script>
    <script>
        $(document).ready(function () {
            IS_CHROME = {% if request|is_chrome %}true{% else %}false{% endif %}
            {% if config and config.address == config.ADDRESS_SHOW %}
                $('#id_zip_code').mask("99999-999");
            {% endif %}
            if ($('#id_city').val()) {
                $.ajax({
                    url: "/api/cities/" + $('#id_city').val(),
                    success: function (result) {
                        $('#id_city_search').val(result.name + ' - ' + result.uf)
                        //populate the html with result here
                    }
                });
            }
            showHideCepLoader();
        });
    </script>

    <!-- SCRIPT Payment -->
    <!-- SCRIPT PAGAR.ME -->
    <script src="https://assets.pagar.me/checkout/1.1.0/checkout.js"></script>
    <script src="{% static "hotsite/js/payment.js" %}"></script>
    <script>
        function load_common_lots() {
            $('#lots-field').html(common_lots_content);
            $('#id_lot').on('change', function () {
                var id = $(this).val();
                $('#id_amount').val(amounts[id]);
            });
            $('#id_lot').trigger('change');

            start_popover();
        }

        var lots = {};
        var amounts = {};
        var all_lots = {};

        {% for lot in paid_lots %}
            {% if lot.price and lot.price > 0 %}
                amounts[['{{ lot.pk }}']] = '{{ lot.get_calculated_price|unlocalize|intcomma }}';
                lots['{{ lot.pk }}'] = {
                    'allow_installment': {% if lot.allow_installment %}
                        true{% else %}false{% endif %},
                    'installment_limit': {% if lot.allow_installment %}{{ lot.installment_limit }}{% else %}0{% endif %},
                    'free_installment': {{ lot.num_install_interest_absortion|default_if_none:0 }}
                };
            {% endif %}
        {% endfor %}

        {% for lot in private_lots %}
            {% if lot.price and lot.price > 0 %}
                amounts[['{{ lot.pk }}']] = '{{ lot.get_calculated_price|unlocalize|intcomma }}';
                lots['{{ lot.pk }}'] = {
                    'allow_installment': {% if lot.allow_installment %}
                        true{% else %}false{% endif %},
                    'installment_limit': {% if lot.allow_installment %}{{ lot.installment_limit }}{% else %}0{% endif %},
                    'free_installment': {{ lot.num_install_interest_absortion|default_if_none:0 }}
                };
            {% endif %}
        {% endfor %}

        {% for lot in lots %}
            all_lots['{{ lot.pk }}'] = {
                'survey': {{ lot.survey.pk }}
            };
        {% endfor %}

        var allowed_transactions;

        {% if request.session.allowed_transaction %}
            allowed_transactions = '{{ request.session.allowed_transaction }}';
        {% else %}
            allowed_transactions = null;
        {% endif %}

        $(document).ready(function () {
            $('#id_email').attr('readonly', 'readonly');
            $('#id_lot').on('change', function () {
                var id = $(this).val();
                $('#id_amount').val(amounts[id]);
            });

            $('#id_button_pay').on('click', function () {
                process_payment(
                    '{{ pagarme_encryption_key }}',
                    2.29,
                    '{{ event.name }}',
                    lots,
                    {#                    allowed_transactions#}
                    null
                );
            });

            var uf_el = $('#id_state');
            var city_el = $('#id_city_name');

            window.setTimeout(function () {
                {% if person.city %}
                    uf_el.val('{{ person.city.uf }}');
                    fetch_cities(uf_el, '{{ person.city.pk }}');
                {% else %}
                    uf_el.val('');
                    city_el.val('');
                    city_el.prop('disabled', true);
                {% endif %}

                $('#id_lot').trigger('change');
            }, 300);

            $('#id_lot').on('change', function () {
                //alert(this.value);

                if(this.value in all_lots){
                    console.log('in lots');
                    var survey_id = all_lots[this.value]['survey'];
                    var lot_survey = $("div[data-survey-id='" +survey_id +"']");
                    console.log(lot_survey);
                    lot_survey.show()
                } else {
                    console.log('not in lots')
                }
            });


        });

    </script>
{% endblock %}
