{% extends 'hotsite/base.html' %}
{% load static user_agents user_agent_tag %}
{% load l10n humanize %}

{% block styles %}
    <style>
        .form-group {
            margin: 4px 0;
        }

        input#id_city, input#id_city_search {
            text-transform: uppercase;
        }

        .loader-box {
            width: 100%;
            position: absolute;
            top: 5%;
        }

        .loader {
            width: 47px;
            margin: 0 auto;
        }
    </style>
{% endblock %}

{% block content %}

    {% include 'hotsite/includes/2_cover_no_form.html' %}

    <!-- FORM
    ================================= -->
    <section id="about" class="about-section section">
        <div class="container">
            <h2 class="section-heading text-center">Inscrição</h2>
            <div class="about-row row">
                <div class="col-md-9 col-md-offset-2">
                    {% include 'hotsite/subscription_form.html' %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block scripts %}

    <!-- SCRIPT Subscription -->
    <script src="{% static "hotsite/js/subscription.js" %}"></script>
    <script>
        $(document).ready(function () {
            IS_CHROME = {% if request|is_chrome %}true{% else %}false{% endif %}


            {% if config and config.address == config.ADDRESS_SHOW %}
                $('#id_zip_code').mask("99999-999");
            {% endif %}

            if ($('#id_city').val()) {
                $.ajax({
                    url: "/api/cities/" + $('#id_city').val(),
                    success: function (result) {
                        $('#id_city_search').val(result.name + ' - ' + result.uf)
                        //populate the html with result here
                    }
                });
            }

            showHideCepLoader();

            //Happens only once, after page has finished loading
            var lots_list_element = $('#id_lot');
            var lot_id = lots_list_element.val();
            if (lot_id in all_lots_with_surveys) {
                console.log('Initial is in lots.');
                loadSurveyFromLot(all_lots_with_surveys[lot_id].survey)
            }

            //Happens on every lot change.
            lots_list_element.on('change', function () {
                $('.survey_form').hide();
                var id = $(this).val();
                if (id in all_lots_with_surveys) {
                    loadSurveyFromLot(all_lots_with_surveys[id].survey)
                }
            });

        });

        function loadSurveyFromLot(id) {
            $('div').filter('[data-survey-id="' + id + '"]').show();
        }

    </script>

    <!-- SCRIPT Payment -->
    <!-- SCRIPT PAGAR.ME -->
    <script src="https://assets.pagar.me/checkout/1.1.0/checkout.js"></script>
    <script src="{% static "hotsite/js/payment.js" %}"></script>
    <script>
        function load_common_lots() {
            $('#lots-field').html(common_lots_content);
            $('#id_lot').on('change', function () {
                var id = $(this).val();
                $('#id_amount').val(amounts[id]);
            });
            $('#id_lot').trigger('change');

            start_popover();
        }

        var lots = {};
        var amounts = {};
        var all_lots_with_surveys = {};

        {% for lot in paid_lots %}
            {% if lot.price and lot.price > 0 %}
                amounts[['{{ lot.pk }}']] = '{{ lot.get_calculated_price|unlocalize|intcomma }}';
                lots['{{ lot.pk }}'] = {
                    'allow_installment': {% if lot.allow_installment %}
                        true{% else %}false{% endif %},
                    'installment_limit': {% if lot.allow_installment %}{{ lot.installment_limit }}{% else %}0{% endif %},
                    'free_installment': {{ lot.num_install_interest_absortion|default_if_none:0 }}
                };
            {% endif %}
        {% endfor %}

        {% for lot in private_lots %}
            {% if lot.price and lot.price > 0 %}
                amounts[['{{ lot.pk }}']] = '{{ lot.get_calculated_price|unlocalize|intcomma }}';
                lots['{{ lot.pk }}'] = {
                    'allow_installment': {% if lot.allow_installment %}
                        true{% else %}false{% endif %},
                    'installment_limit': {% if lot.allow_installment %}{{ lot.installment_limit }}{% else %}0{% endif %},
                    'free_installment': {{ lot.num_install_interest_absortion|default_if_none:0 }}
                };
            {% endif %}
        {% endfor %}

        {% for lot in lots %}
            {% if lot.survey.pk %}
                all_lots_with_surveys['{{ lot.pk }}'] = {
                    'survey': {{ lot.survey.pk }}
                };
            {% endif %}
        {% endfor %}

        var allowed_transactions;

        {% if request.session.allowed_transaction %}
            allowed_transactions = '{{ request.session.allowed_transaction }}';
        {% else %}
            allowed_transactions = null;
        {% endif %}

    </script>
{% endblock %}
